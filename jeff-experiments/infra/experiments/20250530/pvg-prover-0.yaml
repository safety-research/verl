#  sky launch -c jeff-cotdecomp-8xh100 jeff-experiments/infra/base_job.yaml  --down
resources:
  cloud: runpod
  accelerators: H200:4
  region: US
  disk_size: 4000
  image_id: runpod/pytorch:2.4.0-py3.11-cuda12.4.1-devel-ubuntu22.04

file_mounts:
  ~/.ssh/id_rsa: ~/.ssh/id_rsa
  ~/.ssh/config: ~/.ssh/config
  ~/.netrc: ~/.netrc
  ~/.cache/huggingface/token: ~/.cache/huggingface/token
  ~/sky_workdir/verl: ~/verl
  ~/sky_workdir/cot-decomp: ~/cot-decomp
  ~/.env_anthropic: ~/.env_anthropic
  # CHANGE ME
  ~/data/raw_prompts/train.parquet: /Users/jeff/cot-decomp/output/loan_dataset_pvg0_10k/train_dataset.parquet
  ~/data/raw_prompts/val.parquet: /Users/jeff/cot-decomp/output/loan_dataset_pvg0_10k/test_dataset.parquet

# working dir is ~/sky_workdir/

envs:
  # CHANGE ME
  EXPERIMENT_NAME: prover0
  PROJECT_NAME: pvg
  REF_MODEL: Qwen/Qwen2.5-7B-Instruct
  VERIFIER_PATH: /root/verifier0/checkpoint-1368

setup: |
  set -e
  echo "Running setup."
  chown -R root ~/.ssh
  chmod -R 700 ~/.ssh
  ~/sky_workdir/verl/jeff-experiments/infra/base_setup.sh


# Remember to change lora_merge.py and fsdp_sft_trainer.py to use the correct model loader
# TODO(sguo35): rewrite this to be cleaner

  # conda deactivate && source ~/sky_workdir/anthropic/bin/activate && python ~/sky_workdir/cot-decomp/sft/datagen/loan_dataset/generate_pvg_start.py --model Qwen/Qwen2.5-7B-Instruct --prompt-file ~/data/raw_prompts/train.parquet --temperature 1.0 --max-tokens 4096 --tensor-parallel-size 4 --output-file ~/data/prover0/train.parquet
  # conda deactivate && source ~/sky_workdir/anthropic/bin/activate && python ~/sky_workdir/cot-decomp/sft/datagen/loan_dataset/generate_pvg_start.py --model Qwen/Qwen2.5-7B-Instruct --prompt-file ~/data/raw_prompts/val.parquet --temperature 1.0 --max-tokens 4096 --tensor-parallel-size 4 --output-file ~/data/prover0/val.parquet

run: |
  set -e

  source ~/.env_anthropic

  conda deactivate && source ~/sky_workdir/anthropic/bin/activate && ~/sky_workdir/verl/jeff-experiments/grpo_scripts/run_rlvr_pvg.sh

# python verl/scripts/model_merger.py --backend fsdp --local_dir checkpoints/pvg/prover0/global_step_88/actor --target_dir /root/sky_workdir/checkpoints/pvg/prover0/global_step_88/actor/huggingface --hf_model_path Qwen/Qwen2.5-7B-Instruct